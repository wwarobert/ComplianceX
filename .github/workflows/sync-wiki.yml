# Sync documentation to GitHub Wiki
# This workflow automatically syncs docs/ folder to the GitHub Wiki
#
# Setup Required:
# 1. Create a Personal Access Token (PAT) with 'repo' scope
# 2. Add it as a repository secret named 'WIKI_TOKEN'
# 3. Go to Settings > Secrets and variables > Actions > New repository secret
#
# Alternative: Use manual wiki sync or disable this workflow if wiki access is restricted

name: Sync Wiki

on:
  push:
    branches:
      - main
      - feature/004-fix-wiki-sync-bash-error  # TEMP: Remove before merging
    paths:
      - 'docs/**'
      - '.github/copilot-instructions.md'
      - '.github/workflows/sync-wiki.yml'  # Also trigger on workflow changes
  workflow_dispatch:

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    # Only run if WIKI_TOKEN secret is configured
    if: github.event_name == 'workflow_dispatch' || vars.ENABLE_WIKI_SYNC == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for wiki token
        id: check_token
        run: |
          if [ -z "${{ secrets.WIKI_TOKEN }}" ]; then
            echo "âš ï¸ WIKI_TOKEN secret not configured"
            echo "See workflow comments for setup instructions"
            exit 1
          fi

      - name: Checkout wiki
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          token: ${{ secrets.WIKI_TOKEN }}

      - name: Sync documentation to wiki
        run: |
          # Clear wiki directory
          rm -rf wiki/*
          
          # Copy all documentation files (maintains structure)
          cp -r docs/* wiki/
          
          # Store repository URL in variable to avoid bash interpolation issues
          REPO_URL="https://github.com/${{ github.repository }}"
          
          # Create wiki Home page with clean navigation
          cat > wiki/Home.md << EOF
          # ComplianceX Documentation

          Welcome to ComplianceX! This wiki is automatically synced from the docs/ folder.

          ## ðŸš€ Quick Start

          - **[Getting Started](Getting-Started.md)** - New to ComplianceX? Start here
          - **[Installation](setup/Installation.md)** - Install and configure
          - **[Your First Rule](plugins/Your-First-Rule.md)** - Create your first compliance rule

          ## ðŸ“– Documentation

          ### For Users
          - [Getting Started](Getting-Started.md)
          - [Installation Guide](setup/Installation.md)
          - [Configuration](setup/Configuration.md)
          - [Deployment](setup/Deployment.md)

          ### For Developers
          - [Development Setup](development/Development-Setup.md)
          - [Architecture Overview](development/Architecture.md)
          - [API Reference](api/API-Reference.md)
          - [Contributing Guide](development/Contributing.md)

          ### For Plugin Authors
          - [Plugin Development](plugins/Plugin-Development.md)
          - [Your First Rule](plugins/Your-First-Rule.md)
          - [Plugin Examples](plugins/Examples.md)
          - [Plugin API Reference](plugins/API-Reference.md)

          ### Guidelines & Standards
          - [Branching Strategy](development/Branching-Strategy.md)
          - [Naming Conventions](development/Naming-Conventions.md)
          - [GitHub Copilot Guide](development/GitHub-Copilot-Guide.md)
          - [Feature Roadmap](development/Feature-Roadmap.md)

          ## ðŸ”— Links

          - [GitHub Repository]($REPO_URL)
          - [Issue Tracker]($REPO_URL/issues)
          - [Discussions]($REPO_URL/discussions)

          ---

          _This wiki is automatically updated when docs/ changes in the main branch._
          EOF
          - [Issue Tracker](https://github.com/${{ github.repository }}/issues)
          - [Discussions](https://github.com/${{ github.repository }}/discussions)

          ---

          _This wiki is automatically updated when docs/ changes in the main branch._
          EOF
          - [Marketplace Deployment](setup/marketplace-deployment.md)

          ---

          **Note**: This wiki is automatically synced from the [docs/](https://github.com/${{ github.repository }}/tree/main/docs) folder in the repository.
          EOF

      - name: Commit and push to wiki
        working-directory: wiki
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --quiet && git diff --staged --quiet || (git commit -m "Sync documentation from main repository" && git push)
